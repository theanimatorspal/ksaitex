% METADATA DEFINITIONS (Hidden from PDF output)
% \VAR{ page_size, default='a4paper', tab='लेआउट', label='कागजको आकार', type='select', options='a4paper|a5paper|b5paper|letterpaper|legalpaper' }
% \VAR{ font_size, default='12pt', tab='लेआउट', label='अक्षरको आकार', type='select', options='10pt|11pt|12pt' }
% \VAR{ document_class, default='article', tab='लेआउट', label='कागजको ढाँचा', type='select', options='article|report|book' }
% \VAR{ top_margin, default='1in', tab='लेआउट', label='माथिल्लो मार्जिन' }
% \VAR{ bottom_margin, default='1in', tab='लेआउट', label='तल्लो मार्जिन' }
% \VAR{ left_margin, default='0.5in', tab='लेआउट', label='बायाँ मार्जिन' }
% \VAR{ right_margin, default='0.5in', tab='लेआउट', label='दायाँ मार्जिन' }
% \VAR{ line_spacing, default='1.3', tab='लेआउट', label='पङ्क्ति बिचको दुरी', type='select', options='1.0|1.2|1.3|1.5|2.0' }
% \VAR{ paragraph_spacing, default='10pt', tab='लेआउट', label='अनुच्छेद बिचको दुरी', type='select', options='0pt|4pt|6pt|10pt|12pt' }
% \VAR{ paragraph_indent, default='10pt', tab='लेआउट', label='अनुच्छेदको सुरुको खाली ठाउँ', type='select', options='0pt|10pt|20pt|30pt' }
% \VAR{ script, default='DEVANAGARI', tab='लेआउट', label='लिपि प्रणाली', type='select', options='DEVANAGARI|LATIN' }
% \VAR{ theme_color, default='black', tab='लेआउट', label='थिम रङ', type='select', options='red|blue|green|orange|black|purple' }
% \VAR{ font_file, default='Tiro Devanagari Sanskrit', tab='लेआउट', label='मुख्य फन्ट' }

% \MAGIC{ paragraph, label='अनुच्छेद शीर्षक', tab='ढाँचा', args='title:text:नयाँ संख्याहीन अनुच्छेद शीर्षक', command='\customparagraph{VAR_title}' }
% \MAGIC{ khanda, label='खण्ड', tab='ढाँचा', args='title:text:नयाँ खण्ड', command='\khanda{VAR_title}' }
% \MAGIC{ upakhanda, label='उपखण्ड', tab='ढाँचा', args='title:text:नयाँ उपखण्ड', command='\upakhanda{VAR_title}' }
% \MAGIC{ upaupakhanda, label='उप-उपखण्ड', tab='ढाँचा', args='title:text:नयाँ उप-उपखण्ड', command='\upaupakhanda{VAR_title}' }

% \MAGIC{ special_khanda, label='विशेष खण्ड', tab='ढाँचा', args='title:text:नयाँ विशेष खण्ड', command='\specialkhanda{VAR_title}' }
% \MAGIC{ special_upakhanda, label='विशेष उपखण्ड', tab='ढाँचा', args='title:text:नयाँ विशेष उपखण्ड', command='\specialupakhanda{VAR_title}' }
% \MAGIC{ special_upaupakhanda, label='विशेष उप-उपखण्ड', tab='ढाँचा', args='title:text:नयाँ विशेष उप-उपखण्ड', command='\specialupaupakhanda{VAR_title}' }

% \MAGIC{ mahakhanda, label='महाखण्ड (अध्याय)', tab='ढाँचा', args='title:text:नयाँ महाखण्ड', command='\mahakhanda{VAR_title}' }
% \MAGIC{ special_mahakhanda, label='विशेष महाखण्ड', tab='ढाँचा', args='title:text:नयाँ विशेष महाखण्ड', command='\specialmahakhanda{VAR_title}' }

% \MAGIC{ section, label='संख्याहीन शीर्षक', tab='ढाँचा', args='title:text:नयाँ संख्याहीन शीर्षक', command='\section*{VAR_title}' }
% \MAGIC{ subsection, label='संख्याहीन उपशीर्षक', tab='ढाँचा', args='title:text:नयाँ संख्याहीन उपशीर्षक', command='\subsection*{VAR_title}' }
% \MAGIC{ subsubsection, label='संख्याहीन उप-उपशीर्षक', tab='ढाँचा', args='title:text:नयाँ संख्याहीन उप-उपशीर्षक', command='\subsubsection*{VAR_title}' }

% \MAGIC{ section_toc, label='संख्याहीन शीर्षक सूचीमा देखाउने', tab='ढाँचा', args='title:text:नयाँ संख्याहीन शीर्षक', command='\section*{VAR_title}\addcontentsline{toc}{section}{VAR_title}' }
% \MAGIC{ subsection_toc, label='संख्याहीन उपशीर्षक सूचीमा देखाउने', tab='ढाँचा', args='title:text:नयाँ संख्याहीन उपशीर्षक', command='\subsection*{VAR_title}\addcontentsline{toc}{subsection}{VAR_title}' }
% \MAGIC{ subsubsection_toc, label='संख्याहीन उप-उपशीर्षक सूचीमा देखाउने', tab='ढाँचा', args='title:text:नयाँ संख्याहीन उप-उपशीर्षक', command='\subsubsection*{VAR_title}\addcontentsline{toc}{subsubsection}{VAR_title}' }

% \MAGIC{ box_begin, label='बक्स सुरु', tab='ढाँचा', pairing='begin', group='box', args='title:text:शीर्षक', command='\begin{tcolorbox}[title=VAR_title, colback=theme!5!white, colframe=theme!75!black]' }
% \MAGIC{ box_end, label='बक्स अन्त्य', tab='ढाँचा', pairing='end', group='box', command='\end{tcolorbox}' }
% \MAGIC{ toc, label='विषय सूची', tab='ढाँचा', args='title:text:विषय सूची|nums:select,devanagari,latin:devanagari', command='\renewcommand{\contentsname}{VAR_title} \ifthenelse{\equal{VAR_nums}{devanagari}}{ \renewcommand{\thepage}{\devanagaridigits{\value{page}}} \renewcommand{\thepart}{\devanagaridigits{\value{part}}} \renewcommand{\thesection}{\devanagaridigits{\value{section}}} \renewcommand{\thesubsection}{\thesection.\devanagaridigits{\value{subsection}}} \renewcommand{\thesubsubsection}{\thesubsection.\devanagaridigits{\value{subsubsection}}} }{ \pagenumbering{arabic} \renewcommand{\thepart}{\arabic{part}} \renewcommand{\thesection}{\arabic{section}} \renewcommand{\thesubsection}{\thesection.\arabic{subsection}} \renewcommand{\thesubsubsection}{\thesubsection.\arabic{subsubsection}} } \tableofcontents' }
% \MAGIC{ image, label='तस्बिर', tab='ढाँचा', args='file:image:तस्बिर छान्नुहोस्|align:select,Center,Left,Right:Center|width:text:0.8', command='\customimage{VAR_file}{VAR_align}{VAR_width}' }

% \MAGIC{ page_break, label='नयाँ पृष्ठ', tab='पृष्ठ', command='\pagebreak' }
% \MAGIC{ devanagari_num, label='देवनागरी अंक सुरु', tab='पृष्ठ', command='\renewcommand{\thepage}{\devanagaridigits{\value{page}}}' }
% \MAGIC{ devanagari_alph, label='देवनागरी अक्षर सुरु', tab='पृष्ठ', command='\renewcommand{\thepage}{\devanagarialph{\value{page}}}' }
% \MAGIC{ horizontal_rule, label='तेर्सो रेखा', tab='पृष्ठ', command='\hrule' }
% \MAGIC{ empty_page, label='पृष्ठ संख्या नदेखाउनुहोस्', tab='पृष्ठ', command='\thispagestyle{empty}' }
% \MAGIC{ set_page_counter, label='पृष्ठ संख्या सेट गर्नुहोस्', tab='पृष्ठ', args='num:number:1', command='\setcounter{page}{VAR_num}' }

% \MAGIC{ center_begin, label='बिचमा सुरु', tab='ढाँचा', pairing='begin', group='center', command='\begin{center}' }
% \MAGIC{ center_end, label='बिचमा अन्त्य', tab='ढाँचा', pairing='end', group='center', command='\end{center}' }
% \MAGIC{ flush_right_begin, label='दायाँ सुरु', tab='ढाँचा', pairing='begin', group='right', command='\begin{flushright}' }
% \MAGIC{ flush_right_end, label='दायाँ अन्त्य', tab='ढाँचा', pairing='end', group='right', command='\end{flushright}' }
% \MAGIC{ flush_left_begin, label='बायाँ सुरु', tab='ढाँचा', pairing='begin', group='left', command='\begin{flushleft}' }
% \MAGIC{ flush_left_end, label='बायाँ अन्त्य', tab='ढाँचा', pairing='end', group='left', command='\end{flushleft}' }
% \MAGIC{ vfill, label='ठाउँ भर्नुहोस्', tab='ढाँचा', command='\vfill' }
% \MAGIC{ vertical_space, label='खाली ठाउँ', tab='ढाँचा', args='cm:number:1', command='\vspacer{VAR_cm}' }
% \MAGIC{ quote_begin, label='भनाइ सुरु', tab='ढाँचा', pairing='begin', group='quote', command='\vspace{0.5cm}\begin{quote}' }
% \MAGIC{ quote_end, label='भनाइ अन्त्य', tab='ढाँचा', pairing='end', group='quote', command='\end{quote}\vspace{0.5cm}' }
% \MAGIC{ sloppy_begin, label='स्लोपी सुरु', tab='ढाँचा', pairing='begin', group='sloppy', command='{\sloppy' }
% \MAGIC{ sloppy_end, label='स्लोपी अन्त्य', tab='ढाँचा', pairing='end', group='sloppy', command='\par}' }

% \VAR{ header_rule, default='On', tab='हेडर-फुटर', label='हेडर लाइन', type='select', options='On|Off' }
% \VAR{ footer_rule, default='Off', tab='हेडर-फुटर', label='फुटर लाइन', type='select', options='On|Off' }

% \VAR{ header_left, default='None', tab='हेडर-फुटर', label='हेडर बायाँ', type='select', options='None|Section|Khanda|Page|Custom' }
% \VAR{ header_left_text, default='', tab='हेडर-फुटर', label='— कस्टम पाठ' }
% \VAR{ header_right, default='None', tab='हेडर-फुटर', label='हेडर दायाँ', type='select', options='None|Section|Khanda|Page|Custom' }
% \VAR{ header_right_text, default='', tab='हेडर-फुटर', label='— कस्टम पाठ' }
% \VAR{ header_center, default='None', tab='हेडर-फुटर', label='हेडर मध्य', type='select', options='None|Section|Khanda|Page|Custom' }
% \VAR{ header_center_text, default='', tab='हेडर-फुटर', label='— कस्टम पाठ' }
% \VAR{ footer_left, default='None', tab='हेडर-फुटर', label='फुटर बायाँ', type='select', options='None|Section|Khanda|Page|Custom' }
% \VAR{ footer_left_text, default='', tab='हेडर-फुटर', label='— कस्टम पाठ' }
% \VAR{ footer_right, default='None', tab='हेडर-फुटर', label='फुटर दायाँ', type='select', options='None|Section|Khanda|Page|Custom' }
% \VAR{ footer_right_text, default='', tab='हेडर-फुटर', label='— कस्टम पाठ' }
% \VAR{ footer_center, default='Page', tab='हेडर-फुटर', label='फुटर मध्य', type='select', options='None|Section|Khanda|Page|Custom' }
% \VAR{ footer_center_text, default='', tab='हेडर-फुटर', label='— कस्टम पाठ' }

\documentclass[\VAR{font_size}, \VAR{page_size}]{\VAR{document_class}}

\usepackage{fontspec}
\usepackage{polyglossia}
\usepackage{geometry}
\usepackage{fancyhdr}
\usepackage{tcolorbox}
\usepackage{ifthen}
\usepackage{tikz}
\usetikzlibrary{shadows}
\usepackage{xcolor}
\usepackage{microtype}
\usepackage{graphicx}
\usepackage{float}
\usepackage[object = vectorian]{pgfornament}
\emergencystretch=3cm


\usepackage{luacode}

% Lua function to insert a penalty after purnaviram
\begin{luacode*}
function prevent_purnaviram_start_line(head)
  local current = head
  while current do
    if current.id == node.id("glyph") then
      if unicode.utf8.char(current.char) == "।" then
        -- check previous node
        if current.prev and current.prev.id == node.id("glue") then
          local penalty = node.new("penalty")
          penalty.penalty = 10000
          head = node.insert_before(head, current.prev, penalty)
        end
      end
    end
    current = current.next
  end
  return head
end

luatexbase.add_to_callback("pre_linebreak_filter", prevent_purnaviram_start_line, "Prevent purnaviram line break")
\end{luacode*}


\geometry{
    top=\VAR{top_margin},
    bottom=\VAR{bottom_margin},
    left=\VAR{left_margin},
    right=\VAR{right_margin}
}

% --- spacing configuration ---
\linespread{\VAR{line_spacing}}
\setlength{\parskip}{\VAR{paragraph_spacing}}
\setlength{\parindent}{\VAR{paragraph_indent}}

% --- Devanagari Page Numbering Macros ---
\makeatletter
\def\devanagaridigits#1{\expandafter\@devanagaridigits\number#1@}
\def\@devanagaridigits#1{%
  \ifx#1@\else
    \ifcase#1 ०\or १\or २\or ३\or ४\or ५\or ६\or ७\or ८\or ९\fi
    \expandafter\@devanagaridigits
  \fi
}

\def\devanagarialph#1{\expandafter\@devanagarialph\number#1}
\def\@devanagarialph#1{%
  \ifcase#1\or अ\or आ\or इ\or ई\or उ\or ऊ\or ऋ\or ॠ\or ऌ\or ॡ\or ए\or ऐ\or ओ\or औ\or क\or ख\or ग\or घ\or ङ\or च\or छ\or ज\or झ\or ञ\or ट\or ठ\or ड\or ढ\or ण\or त\or थ\or द\or ध\or न\or प\or फ\or ब\or भ\or म\or य\or र\or ल\or व\or श\or ष\or स\or ह\or ळ\or क्ष\or ज्ञ\else\@ctrerr\fi
}
\makeatother

\pagestyle{fancy}
\fancyhf{} 

\BLOCK{ if script == 'DEVANAGARI' }
    \renewcommand{\thesection}{\devanagaridigits{\value{section}}}
    \renewcommand{\thesubsection}{\thesection.\devanagaridigits{\value{subsection}}}
    \renewcommand{\thesubsubsection}{\thesubsection.\devanagaridigits{\value{subsubsection}}}
\BLOCK{ endif }

% -- Rules --
\BLOCK{ if header_rule == 'On' }
    \renewcommand{\headrulewidth}{0.4pt}
\BLOCK{ else }
    \renewcommand{\headrulewidth}{0pt}
\BLOCK{ endif }

\BLOCK{ if footer_rule == 'On' }
    \renewcommand{\footrulewidth}{0.4pt}
\BLOCK{ else }
    \renewcommand{\footrulewidth}{0pt}
\BLOCK{ endif }

% -- Header Left --
\BLOCK{ if header_left == 'Khanda' or header_left == 'Section' }
    \lhead{\leftmark}
\BLOCK{ elif header_left == 'Page' }
    \lhead{\thepage}
\BLOCK{ elif header_left == 'Custom' }
    \lhead{\VAR{header_left_text}}
\BLOCK{ endif }

% -- Header Right --
\BLOCK{ if header_right == 'Khanda' or header_right == 'Section' }
    \rhead{\leftmark}
\BLOCK{ elif header_right == 'Page' }
    \rhead{\thepage}
\BLOCK{ elif header_right == 'Custom' }
    \rhead{\VAR{header_right_text}}
\BLOCK{ endif }

% -- Header Center --
\BLOCK{ if header_center == 'Khanda' or header_center == 'Section' }
    \chead{\leftmark}
\BLOCK{ elif header_center == 'Page' }
    \chead{\thepage}
\BLOCK{ elif header_center == 'Custom' }
    \chead{\VAR{header_center_text}}
\BLOCK{ endif }

% -- Footer Left --
\BLOCK{ if footer_left == 'Khanda' or footer_left == 'Section' }
    \lfoot{\leftmark}
\BLOCK{ elif footer_left == 'Page' }
    \lfoot{\thepage}
\BLOCK{ elif footer_left == 'Custom' }
    \lfoot{\VAR{footer_left_text}}
\BLOCK{ endif }

% -- Footer Right --
\BLOCK{ if footer_right == 'Khanda' or footer_right == 'Section' }
    \rfoot{\leftmark}
\BLOCK{ elif footer_right == 'Page' }
    \rfoot{\thepage}
\BLOCK{ elif footer_right == 'Custom' }
    \rfoot{\VAR{footer_right_text}}
\BLOCK{ endif }

% -- Footer Center --
\BLOCK{ if footer_center == 'Khanda' or footer_center == 'Section' }
    \cfoot{\leftmark}
\BLOCK{ elif footer_center == 'Page' }
    \cfoot{\thepage}
\BLOCK{ elif footer_center == 'Custom' }
    \cfoot{\VAR{footer_center_text}}
\BLOCK{ endif }

% --- Theme Color Definition ---
\definecolor{theme}{named}{\VAR{theme_color}}

% --- Custom Segments (Khanda) ---
\newcommand{\mahakhanda}[1]{
    \cleardoublepage
    \thispagestyle{empty}
    \vspace*{\fill}
    \begin{center}
        \textbf{\Huge \color{theme} #1}
    \end{center}
    \vspace*{\fill}
    \addcontentsline{toc}{part}{#1}
    \setcounter{section}{0}
    \pagebreak
}

\newcommand{\specialmahakhanda}[1]{
    \cleardoublepage
    \thispagestyle{empty}
    \vspace*{\fill}
    \begin{center}
    \begin{tikzpicture}
        \node[inner sep=20pt, fill=theme!10, rounded corners=10pt, drop shadow] (title) {
            \parbox{0.8\textwidth}{\centering \textbf{\Huge \color{theme} #1}}
        };
    \end{tikzpicture}
    \end{center}
    \vspace*{\fill}
    \addcontentsline{toc}{part}{#1}
    \setcounter{section}{0}
    \pagebreak
}
\newcommand{\khanda}[1]{
    \markboth{#1}{}
    \vspace{0.8cm}
    \noindent \textbf{\Huge \color{theme} #1} \hfill \par
    \addcontentsline{toc}{section}{#1}
    \vspace{0.4cm}
}

\newcommand{\upakhanda}[1]{
    \vspace{0.6cm}
    \noindent \textbf{\huge \color{theme} #1} \hfill \par
    \addcontentsline{toc}{subsection}{#1}
    \vspace{0.3cm}
}

\newcommand{\upaupakhanda}[1]{
    \vspace{0.4cm}
    \noindent \textbf{\Large \color{theme} #1} \hfill \par
    \addcontentsline{toc}{subsubsection}{#1}
    \vspace{0.2cm}
}

% --- Custom Paragraph ---
\newcommand{\customparagraph}[1]{
    \vspace{0.2cm}
    \noindent \textbf{#1} \par
    \vspace{0.1cm}
}

% --- Alignment and Spacing Macros ---
\newcommand{\vspacer}[1]{\vspace{#1 cm}}

% --- Image Macros ---
\newcommand{\customimage}[3]{
    \begin{figure}[H]
        \ifthenelse{\equal{#2}{Center}}{\centering}{}
        \ifthenelse{\equal{#2}{Left}}{\raggedright}{}
        \ifthenelse{\equal{#2}{Right}}{\raggedleft}{}
        \includegraphics[width=#3\textwidth]{#1}
    \end{figure}
}

% --- Special segments with TikZ gradient ---
\newcommand{\specialkhanda}[1]{
    \markboth{#1}{}
    \vspace{1.2cm}
    \noindent \textbf{\Huge \color{theme} #1} \hfill \par \nointerlineskip
    \addcontentsline{toc}{section}{#1}
    \noindent\begin{tikzpicture}[remember picture, overlay]
        \shade[left color=theme!80!white, right color=white] (0,-0.4) rectangle (\textwidth, -0.2);
    \end{tikzpicture}
    \vspace{0.8cm}
}

\newcommand{\specialupakhanda}[1]{
    \vspace{0.8cm}
    \noindent \textbf{\huge \color{theme} #1} \hfill \par \nointerlineskip
    \addcontentsline{toc}{subsection}{#1}
    \noindent\begin{tikzpicture}[remember picture, overlay]
        \shade[left color=theme!60!white, right color=white] (0,-0.3) rectangle (\textwidth, -0.15);
    \end{tikzpicture}
    \vspace{0.6cm}
}

\newcommand{\specialupaupakhanda}[1]{
    \vspace{0.4cm}
    \noindent \textbf{\Large \color{theme} #1} \hfill \par \nointerlineskip
    \noindent\begin{tikzpicture}[remember picture, overlay]
        \shade[left color=theme!40!white, right color=white] (0,-0.2) rectangle (\textwidth, -0.1);
    \end{tikzpicture}
    \vspace{0.4cm}
    \addcontentsline{toc}{subsubsection}{#1}
}

% --- Font Configuration ---
\BLOCK{ if script == 'DEVANAGARI' }
    \setmainfont[Script=Devanagari, AutoFakeBold=1.8]{\VAR{font_file}}
\BLOCK{ else }
    \setmainfont[AutoFakeBold=2.5]{\VAR{font_file}}
\BLOCK{ endif }

\begin{document}

\VAR{ content }

\end{document}
